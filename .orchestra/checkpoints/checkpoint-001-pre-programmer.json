{
  "version": 2,
  "project_name": "hush-matrix-refactor",
  "created_at": "2026-02-12T14:34:19Z",
  "updated_at": "2026-02-12T14:36:02Z",
  "current_phase": "implementation",
  "iteration": 1,
  "next_actor": "programmer",
  "next_action": "implement_synapse_postgres_docker_services",
  "current_task": {
    "id": "A1.1",
    "title": "Add Synapse + PostgreSQL to docker-compose",
    "description": "Set up the Matrix homeserver infrastructure. Add Synapse and PostgreSQL services to docker-compose.yml. Create the synapse/ directory with a homeserver.yaml template that enables guest access, registration, and E2EE. Create a setup script that generates signing keys and initial config.\n\nKey requirements:\n1. Synapse service using matrixdotorg/synapse:latest\n2. PostgreSQL 16-alpine as the database (Synapse default is SQLite but Postgres is required for production)\n3. homeserver.yaml must enable: allow_guest_access: true, enable_registration: true, and E2EE support\n4. Script to generate signing keys (ed25519) and macaroon secret\n5. Synapse must depend on postgres being healthy before starting\n6. Use volume mounts for data persistence",
    "acceptance_criteria": [
      "docker-compose.yml contains synapse and postgres services",
      "synapse/ directory exists with homeserver.yaml template",
      "scripts/generate-synapse-config.sh exists and is executable",
      "Running the generate script creates a valid homeserver.yaml from template",
      "Synapse depends_on postgres with condition: service_healthy",
      "Postgres has a healthcheck defined",
      "Environment variables are used for sensitive values (POSTGRES_PASSWORD, etc.)"
    ],
    "files_to_create": [
      "synapse/homeserver.yaml.template",
      "scripts/generate-synapse-config.sh"
    ],
    "files_to_modify": [
      "docker-compose.yml"
    ],
    "feedback_ref": null
  },
  "task_queue": [
    {
      "id": "A1.2",
      "title": "Add reverse proxy config (Caddy) to docker-compose",
      "description": "Add Caddy as a reverse proxy to route traffic. Route / to the Hush client and /_matrix/* to Synapse. Configure CORS appropriately.",
      "files_to_create": [
        "caddy/Caddyfile"
      ],
      "files_to_modify": [
        "docker-compose.yml"
      ]
    },
    {
      "id": "A1.3",
      "title": "Verify Synapse health check and guest registration",
      "description": "Add health check for Synapse in docker-compose. Create test script to verify /_matrix/client/versions and guest registration work.",
      "files_to_create": [
        "scripts/test-synapse.sh"
      ],
      "files_to_modify": [
        "docker-compose.yml"
      ]
    },
    {
      "id": "A2.1",
      "title": "Install matrix-js-sdk and create matrixClient.js",
      "description": "Install matrix-js-sdk in the client. Create client/src/lib/matrixClient.js singleton.",
      "files_to_create": [
        "client/src/lib/matrixClient.js"
      ],
      "files_to_modify": [
        "client/package.json"
      ]
    },
    {
      "id": "A2.2",
      "title": "Create useMatrixAuth hook",
      "description": "Create client/src/hooks/useMatrixAuth.js for login, register, and guest access.",
      "files_to_create": [
        "client/src/hooks/useMatrixAuth.js"
      ],
      "files_to_modify": []
    },
    {
      "id": "A2.3",
      "title": "Update Home.jsx for Matrix auth",
      "description": "Update Home.jsx to use Matrix auth. Room creation uses matrixClient.createRoom() with E2EE.",
      "files_to_create": [],
      "files_to_modify": [
        "client/src/pages/Home.jsx"
      ]
    },
    {
      "id": "A2.4",
      "title": "Create Matrix-to-JWT bridge for Socket.io",
      "description": "Create temporary bridge layer: after Matrix auth, generate internal JWT for Socket.io (mediasoup still needs it). This is temporary glue removed in Milestone B.",
      "files_to_create": [],
      "files_to_modify": [
        "server/src/auth/auth.js"
      ]
    },
    {
      "id": "A3.1",
      "title": "Rewrite Chat.jsx for Matrix timeline",
      "description": "Rewrite Chat.jsx to use matrix-js-sdk room timeline. Listen to RoomEvent.Timeline, use client.sendEvent() for outgoing. Messages are E2EE via Megolm.",
      "files_to_create": [],
      "files_to_modify": [
        "client/src/components/Chat.jsx"
      ]
    },
    {
      "id": "A3.2",
      "title": "Remove Socket.io chat events from server",
      "description": "Remove sendMessage and messageReceived Socket.io events from socketHandlers.js. Remove server-side chat rate limiting. Keep mediasoup handlers intact.",
      "files_to_create": [],
      "files_to_modify": [
        "server/src/signaling/socketHandlers.js"
      ]
    },
    {
      "id": "A3.3",
      "title": "Test chat persistence and encryption",
      "description": "Verify chat persists across page refresh. Verify m.room.encryption state event exists in room.",
      "files_to_create": [
        "scripts/test-chat.sh"
      ],
      "files_to_modify": []
    }
  ],
  "completed_tasks": [],
  "last_architect_output": "Iteration 0 â†’ Planning complete. Created task breakdown for Milestone A (Matrix Foundation). Starting with Phase A1: Infrastructure Setup. First task A1.1 assigned: Add Synapse + PostgreSQL to docker-compose. The programmer should create the synapse/ directory with homeserver.yaml template, scripts/generate-synapse-config.sh, and modify docker-compose.yml to add both services with proper health checks and dependencies.",
  "last_programmer_output": "",
  "files_created": [
    ".orchestra/PLAN.md"
  ],
  "feedback_resolved": [],
  "status": "running"
}
