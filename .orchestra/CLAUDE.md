# Orchestra Instructions â€” Hush E2EE Fix

## Mission

Fix the broken Matrix E2EE implementation by adopting Cinny's working patterns.

**Reference codebase:** `/Users/yarin/development/hush-v2` (Cinny fork)

---

## The Problem

Matrix E2EE is broken because:
1. No IndexedDBStore â†’ state not persisted
2. No IndexedDBCryptoStore â†’ crypto keys not persisted
3. No cryptoCallbacks â†’ secret storage inaccessible
4. Wrong initialization order â†’ crypto fails silently

---

## The Solution

Copy Cinny's approach from `/Users/yarin/development/hush-v2/src/client/initMatrix.ts`:

```javascript
// 1. Create stores
const indexedDBStore = new IndexedDBStore({
  indexedDB: global.indexedDB,
  localStorage: global.localStorage,
  dbName: 'hush-sync-store',
});

const cryptoStore = new IndexedDBCryptoStore(
  global.indexedDB,
  'hush-crypto-store'
);

// 2. Create client with stores
const client = createClient({
  baseUrl,
  accessToken,
  userId,
  deviceId,
  store: indexedDBStore,
  cryptoStore: cryptoStore,
  cryptoCallbacks: cryptoCallbacks,
  timelineSupport: true,
});

// 3. CORRECT ORDER: startup â†’ initRustCrypto â†’ startClient
await indexedDBStore.startup();
await client.initRustCrypto();
await client.startClient({ initialSyncLimit: 20 });
```

---

## Files to Modify

### 1. `client/src/lib/matrixClient.js`

**Current:** Creates bare client without stores.

**Target:**
- Import IndexedDBStore, IndexedDBCryptoStore
- Create and configure stores
- Pass stores to createClient
- Export function to get/create stores

### 2. `client/src/lib/secretStorageKeys.js` (NEW)

**Create this file** based on:
`/Users/yarin/development/hush-v2/src/client/secretStorageKeys.js`

Provides cryptoCallbacks for secret storage key management.

### 3. `client/src/hooks/useMatrixAuth.js`

**Current:** Calls initRustCrypto() without store setup.

**Target:**
- Await indexedDBStore.startup() after creating authenticated client
- Then initRustCrypto()
- Then startClient()

---

## DO NOT Modify

- `client/src/hooks/useRoom.js` â€” LiveKit E2EE is CORRECT
- Synapse configuration â€” already configured for E2EE
- Chat.jsx â€” will work automatically once crypto is fixed

---

## Verification Steps

After implementation, verify:

1. **IndexedDB databases exist:**
   - Open DevTools â†’ Application â†’ IndexedDB
   - Look for `hush-sync-store` and `hush-crypto-store`

2. **Crypto initialized:**
   - Console shows: `[useMatrixAuth] Rust crypto initialized successfully`
   - No crypto errors

3. **Keys uploaded:**
   - Network tab shows POST to `/_matrix/client/v3/keys/upload`

4. **Room encryption:**
   - Create room â†’ Network shows `m.room.encryption` state event

5. **Message encryption:**
   - Send message â†’ Network shows `m.room.encrypted` event type

6. **Persistence:**
   - Refresh page â†’ No new `/keys/upload` (keys persist in IndexedDB)

---

## Code Style

Follow the existing hush-app patterns:
- JavaScript (not TypeScript)
- JSDoc comments for public functions
- console.log with `[module]` prefix for debugging
- Graceful error handling (log and continue, don't crash)

---

## Commit Message Format

```
fix: <description>

Co-Authored-By: Claude <noreply@anthropic.com>
```

---

## Critical Reference Files

Read these before making changes:

| Cinny File | Purpose |
|------------|---------|
| `src/client/initMatrix.ts` | Complete client initialization with stores |
| `src/client/secretStorageKeys.js` | Crypto callbacks implementation |
| `src/app/pages/client/ClientRoot.tsx` | Startup flow and lifecycle |

---

## Tips

1. **Test incrementally:** After each phase, test that the app still loads
2. **Check console:** Look for crypto errors after each change
3. **Use DevTools IndexedDB:** Verify databases are created
4. **Don't break guest login:** This is the primary auth flow for Hush
5. **Keep LiveKit E2EE working:** It's already correct, don't touch it


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 15, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #2852 | 3:32 PM | ðŸ”µ | Orchestra Plan Reveals E2EE Implementation Roadmap with Rust Crypto Migration | ~480 |

### Feb 16, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #3036 | 1:55 AM | ðŸ”µ | Hush-App v1 Has Existing Orchestra Plan for E2EE Implementation | ~467 |
</claude-mem-context>