<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 15, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #2852 | 3:32 PM | ðŸ”µ | Orchestra Plan Reveals E2EE Implementation Roadmap with Rust Crypto Migration | ~480 |

### Feb 16, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #3036 | 1:55 AM | ðŸ”µ | Hush-App v1 Has Existing Orchestra Plan for E2EE Implementation | ~467 |
</claude-mem-context>

# Orchestra Instructions for Hush v2

This file contains instructions specific to Orchestra agents working on Hush v2.

---

## Project Context

You are working on **Hush v2**, a fork of [Cinny](https://github.com/cinnyapp/cinny) with LiveKit media streaming capabilities. The goal is to create a privacy-first Discord alternative with working E2EE for both chat (Matrix) and media (LiveKit).

**Key Decision:** We forked Cinny instead of fixing hush-app v1's E2EE because:
1. Cinny's E2EE already works (battle-tested)
2. Next milestone requires Discord-like UX (Cinny has this)
3. Saves weeks of debugging broken crypto implementation

---

## Critical Rules

### 1. TypeScript Only
- All new code must be TypeScript
- When porting from hush-app v1 (JavaScript), convert to TS
- Use proper type annotations, not `any`

### 2. Vanilla Extract for Styling
- Use `@vanilla-extract/css` for styles, not plain CSS
- Themes defined in `src/colors.css.ts`
- See existing Cinny components for patterns

### 3. Jotai for State
- Use Jotai atoms for state management
- Study Cinny's patterns before creating new state
- Don't use plain useState for shared state

### 4. Reference Hush v1 for LiveKit
- **Location**: `/Users/yarin/development/hush-app`
- Port logic, not copy-paste (need to convert JS â†’ TS)
- Key files to reference:
  - `client/src/hooks/useRoom.js` â†’ LiveKit room management
  - `client/src/lib/audioProcessing.js` â†’ Audio pipeline
  - `client/src/lib/noiseGateWorklet.js` â†’ Noise gate
  - `client/src/utils/constants.js` â†’ Quality presets

### 5. Preserve Hush Aesthetic
- Dark theme with amber accent (#d4a053)
- Refer to v1's `client/src/styles/global.css` for exact colors
- Map to Cinny's theme tokens in `src/colors.css.ts`

---

## Workflow

### Before Starting a Phase

1. Read the phase tasks in `.orchestra/PLAN.md`
2. Check if you need to reference hush-app v1 code
3. Understand Cinny's existing patterns for that area

### During Implementation

1. Make incremental changes
2. Test in dev mode (`npm start`)
3. Verify TypeScript compiles (`npm run typecheck`)
4. Check ESLint (`npm run check:eslint`)

### After Completing a Phase

1. Run `npm run typecheck` - must pass
2. Run `npm run lint` - should pass (or document why not)
3. Test in browser - should load without errors
4. Commit with clear message
5. Push to origin

---

## Design System Reference

From hush-app v1 `global.css`:

```css
/* Core Surfaces */
--hush-black:        #08080c
--hush-surface:      #101018
--hush-elevated:     #181824
--hush-hover:        #20202e

/* Signature Amber */
--hush-amber:        #d4a053
--hush-amber-bright: #e8b866
--hush-amber-dim:    #a07a3a
--hush-amber-glow:   rgba(212, 160, 83, 0.15)
--hush-amber-ghost:  rgba(212, 160, 83, 0.08)

/* Borders */
--hush-border:       #1e1e2e
--hush-border-hover: #2e2e42
--hush-border-focus: #3e3e56

/* Text Hierarchy */
--hush-text:         #e4e4ec
--hush-text-secondary: #8888a0
--hush-text-muted:   #555568
--hush-text-ghost:   #3a3a4e

/* Status Colors */
--hush-live:         #34d399
--hush-danger:       #ef4444

/* Typography */
--font-sans:  'Sora', -apple-system, sans-serif
--font-mono:  'JetBrains Mono', 'SF Mono', monospace
```

**Task:** Map these to Cinny's theme token structure in `src/colors.css.ts`.

---

## LiveKit Integration Strategy

### Phase 2.2: Port Hooks

When converting `useRoom.js` â†’ `useRoom.ts`:

1. **Add types**:
   ```typescript
   import { Room, Track, RemoteParticipant } from 'livekit-client';
   ```

2. **Convert state**:
   ```typescript
   // v1 (JS)
   const [room, setRoom] = useState(null);

   // v2 (TS)
   const [room, setRoom] = useState<Room | null>(null);
   ```

3. **E2EE key distribution**:
   - Keep Matrix to-device message approach from v1
   - Type: `io.hush.livekit.e2ee_key`
   - Storage: sessionStorage (same as v1)

### Phase 2.3: Integration Point

Find Cinny's voice channel component:
1. Search for "voice" or "call" in `src/app/`
2. Look for Matrix RTC or VoIP handling
3. Wire LiveKit Room lifecycle to that component

---

## Testing Checklist

After each milestone:

- [ ] TypeScript compiles without errors
- [ ] Dev server starts (`npm start`)
- [ ] App loads in browser
- [ ] No console errors
- [ ] Theme looks correct (dark amber)
- [ ] Matrix chat still works (don't break Cinny's features)

After Milestone 2 (LiveKit):
- [ ] Can join voice channel
- [ ] Audio works
- [ ] E2EE enabled (check DevTools)

After Milestone 3 (Media):
- [ ] Screen share works
- [ ] Quality controls functional
- [ ] Noise gate toggles

---

## Common Pitfalls

### 1. Don't Break Cinny's Features
- Preserve existing Matrix chat functionality
- Don't remove Cinny components unless replacing
- Test that threads, reactions, etc. still work

### 2. TypeScript Strict Mode
- Cinny uses strict TS - no implicit `any`
- Add proper types even if it's tedious
- Use `unknown` not `any` when uncertain

### 3. Vanilla Extract Gotchas
- Styles are type-safe - IDE will help
- Don't mix plain CSS files
- Theme tokens must be defined in `colors.css.ts`

### 4. Matrix SDK Version
- Cinny uses v38 (older than v1's v40)
- Some APIs may differ - check docs if porting breaks
- Rust crypto is NOT in v38 - uses libolm

---

## Resources

- **Cinny codebase**: Explore `src/app/` for patterns
- **LiveKit docs**: https://docs.livekit.io/
- **Vanilla Extract**: https://vanilla-extract.style/
- **Jotai**: https://jotai.org/
- **Matrix JS SDK**: https://github.com/matrix-org/matrix-js-sdk

---

## Communication with User

- The user speaks both English and Italian
- Commit messages should be in English
- Code comments in English
- User prefers direct communication, no fluff

---

## Final Note

**This is a migration, not a rewrite.** We're porting working LiveKit code from v1 into Cinny's structure. Don't reinvent - adapt and integrate.

Good luck! ðŸš€