# Security

This document describes Hush's end-to-end encryption (E2EE) implementation, trust model, and known limitations.

## Encryption algorithms

| Layer | Algorithm | Purpose |
|-------|-----------|---------|
| Device-to-device | Olm | Key exchange for to-device messages (e.g. LiveKit E2EE key distribution) |
| Room chat | Megolm (`m.megolm.v1.aes-sha2`) | Group chat message encryption |
| Media (LiveKit) | AES-GCM via Insertable Streams | Frame-level encryption for voice, video, and screen share |

## Key distribution

- **Chat:** Megolm session keys are exchanged automatically by the Matrix SDK (Olm-encrypted to-device) when crypto is initialized.
- **Media:** The LiveKit E2EE key (AES-128) is generated by the room creator and sent to participants via Matrix to-device messages. Event type: `io.hush.e2ee_key`. These messages are Olm-encrypted by the SDK. The server does not see key material.

## Key rotation (rekeying)

When a participant leaves the LiveKit room, the remaining participant with the lexicographically smallest Matrix user ID (deterministic leader) generates a new key and distributes it to all other remaining participants via Matrix to-device. New joiners receive the current key from the creator/leader on join. This provides forward secrecy for media after a participant leaves.

## Trust model

- **Trust on first use (TOFU):** Devices are trusted when first seen. There is no in-app device verification (no emoji comparison, no QR scan). Users must rely on out-of-band verification if they need to confirm a device.

## Crypto implementation

- **Matrix:** vodozemac (Rust compiled to WebAssembly) via matrix-js-sdk `initRustCrypto()`. Keys are stored in IndexedDB (managed by the SDK). The deprecated libolm path is not used.
- **LiveKit:** The client uses `livekit-client` with `ExternalE2EEKeyProvider` and the official E2EE worker. Keys are generated and held in memory; distribution is via Matrix to-device only.

## Browser support

| Browser | Chat E2EE (Megolm) | Media E2EE (LiveKit) |
|---------|--------------------|----------------------|
| Chromium (Chrome, Edge, Brave, Arc) | Full | Full (Insertable Streams) |
| Firefox | Full | Partial (Insertable Streams support varies) |
| Safari | Full | Limited (Insertable Streams / E2EE worker limitations) |

Full media E2EE requires support for the E2EE worker and Insertable Streams. If the worker fails to load, the app disables media controls (screen share, mic, camera) and shows "Media encryption unavailable".

## Known limitations

- **No device verification UI** — Planned for a future milestone. Users cannot verify other devices in-app.
- **No key backup / SSSS** — Planned for a future milestone. Losing browser data (e.g. clearing site data) can mean losing the ability to decrypt past chat history.
- **No cross-signing** — Not implemented. Verification does not propagate across devices.
- **Guest accounts** — Share the same TOFU trust model as registered accounts; there is no separate guest trust policy.
- **LiveKit token service** — The server does not validate Matrix room membership when issuing a LiveKit token. It validates only the Matrix access token (whoami). Access control relies on the room name being a shared secret and on clients only requesting tokens for rooms they have joined via Matrix.

## Server behaviour (token service)

The LiveKit token endpoint requires a valid Matrix access token in the `Authorization` header. It calls Synapse `/_matrix/client/v3/account/whoami` to establish identity and issues a LiveKit JWT with that user id as participant identity. The server does not check whether the user is in a specific Matrix room; room names are passed by the client and used as the LiveKit room name. Room access is therefore enforced by Matrix (users must join the room to know the room name) and by the shared room name as a secret.
