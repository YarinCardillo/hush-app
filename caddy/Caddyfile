# Caddy reverse proxy configuration for Hush
# Routes API, WebSocket, and LiveKit traffic to the appropriate backend
# Serves built client files for all other requests (SPA)

{
  auto_https off
}

:80 {
  # LiveKit WebSocket signaling (no security headers to avoid breaking upgrade)
  handle /livekit* {
    uri strip_prefix /livekit
    reverse_proxy livekit:7880 {
      header_up Connection {http.request.header.Connection}
      header_up Upgrade {http.request.header.Upgrade}
    }
  }

  # Go API
  handle /api/* {
    reverse_proxy hush-api:8080
  }

  # Go WebSocket
  handle /ws {
    reverse_proxy hush-api:8080 {
      header_up Connection {http.request.header.Connection}
      header_up Upgrade {http.request.header.Upgrade}
    }
  }

  # Client SPA â€” serve built files, fall back to index.html for client-side routing
  handle /* {
    header X-Content-Type-Options "nosniff"
    header X-Frame-Options "DENY"
    header Cross-Origin-Opener-Policy "same-origin"
    root * /srv
    try_files {path} /index.html
    file_server
  }

  log {
    output stdout
    format console
  }
}
